#!/bin/bash

if ! cd "$(git rev-parse --show-toplevel)"; then
  echo "cd error"
  exit 1
fi

branch=$(git rev-parse --abbrev-ref HEAD)
# shellcheck disable=SC2063
ancestor_branch=$(git show-branch | grep '*' | grep -v "${branch}" | head -1 | awk -F'[]~^[]' '{print $2}')

if git rev-parse --verify origin/"${branch}" >/dev/null 2>&1; then
  from=$(git merge-base HEAD origin/"${branch}")
else
  # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆ
  from=${ancestor_branch}
fi

# ç‰¹å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ. å¸¸ã«å®Ÿè¡Œãªã‚‰ifæ–‡ã¯ä¸è¦
if git diff --name-only "${from}".."${branch}" | grep -Eq "^src"; then
  echo "ğŸ” Check src"
  if ! bun run pre:push; then
    echo "âŒ CI failed. Aborting push."
    exit 1
  fi
fi

exit 0
